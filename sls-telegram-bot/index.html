<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="icon" href="/assets/images/favicon.ico">

  <title>Serverless Telegram bot | Carlos Chilla</title>

  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Serverless Telegram bot | Carlos Chilla</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Serverless Telegram bot" />
<meta name="author" content="chillaso" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="You don’t even think to call me Godfather. Instead, you come into my house on the day my daughter is to be married, and you uh ask me to do murder, for money." />
<meta property="og:description" content="You don’t even think to call me Godfather. Instead, you come into my house on the day my daughter is to be married, and you uh ask me to do murder, for money." />
<link rel="canonical" href="https://github.com/sls-telegram-bot/" />
<meta property="og:url" content="https://github.com/sls-telegram-bot/" />
<meta property="og:site_name" content="Carlos Chilla" />
<meta property="og:image" content="https://github.com/assets/images/sls-telegram-bot/sls-telegram.jpeg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-01T00:00:00+00:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"chillaso"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://github.com/assets/images/logo.png"},"name":"chillaso"},"description":"You don’t even think to call me Godfather. Instead, you come into my house on the day my daughter is to be married, and you uh ask me to do murder, for money.","headline":"Serverless Telegram bot","dateModified":"2020-04-01T00:00:00+00:00","datePublished":"2020-04-01T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/sls-telegram-bot/"},"image":"https://github.com/assets/images/sls-telegram-bot/sls-telegram.jpeg","url":"https://github.com/sls-telegram-bot/","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
      
  <link href="/assets/css/screen.css" rel="stylesheet">

  <link href="/assets/css/main.css" rel="stylesheet">

  <script src="/assets/js/jquery.min.js"></script>
  <!-- SW -->
  <link rel="manifest" href="/manifest.json" />
  <script type="text/javascript" src="/assets/js/main.js"></script>
</head>


<!-- change your GA id in _config.yml -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', '', 'auto');
ga('send', 'pageview');
</script>



<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
        <img class="sitenavbar img" src="/assets/images/logo.png" alt="Carlos Chilla">
    </a>
    <!-- End Logo -->


    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/tools.html">Tools</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="https://www.linkedin.com/in/cgarciagonzalez/" target="_blank">
                        Linkedin <i class="fab fa-linkedin-in"> </i>
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="https://github.com/Chillaso">
                        Github <i class="fab fa-github"></i>
                    </a>
                </li>
                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Serverless Telegram bot&url=https://github.com/sls-telegram-bot/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=https://github.com/sls-telegram-bot/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://github.com/sls-telegram-bot/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="/assets/images/avatar.jpeg" alt="Carlos Chilla">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://chillaso.github.io">Carlos Chilla</a><a target="_blank" href="https://github.com/Chillaso" class="btn follow">Follow</a>
                        <span class="author-description">Software Architect working at NTT Data. I love learn new stuffs. Pragmatic and self-educated </span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Serverless Telegram bot</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/sls-telegram-bot/sls-telegram.jpeg" alt="Serverless Telegram bot">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p><em>You don’t even think to call me Godfather. Instead, you come into my house on the day my daughter is to be married, and you uh ask me to do murder, for money.</em></p>

<p>Hello everybody, Chillaso is back! In this difficult days we’re living during COVID-19 I feel information necessity, but I was bored searching for graphs, news and so on… so I decided to fetch that information automatically, or as I’m going to show you, semiautomatically. Let’s see how create a <a href="https://telegram.org/blog/bot-revolution">Telegram bot</a> using <a href="https://github.com/mikeal/bent">Serverless Framework</a>, and some good libraries as <a href="https://github.com/mikeal/bent">Bent</a> or <a href="https://cheerio.js.org/">Cheerio</a> for NodeJS, the language we’ve decided to use for AWS Lambdas(the cloud environment).</p>

<h2 id="index">Index</h2>
<ul>
  <li>Environment installation</li>
  <li>Coding our function</li>
  <li>Serverless configuration</li>
  <li>Creating a Telegram bot</li>
  <li>Deploying and linking back-end</li>
  <li>Conclusions and resources</li>
</ul>

<h3 id="environment-installation">Environment installation</h3>
<p>Serverless philosophy let us be agnostic of cloud and language, this is a big potential because we can decide what language is better for what solution. I’ve decided to use Node.js because two reason. First one is because I want to learn more of javascript and was so bored of web javascript, I need in my life backend javascript, thanks god for Node.js. The second one is because I wanted some fast to develop, and my Golang skills are too basic right now, so the time to develop would be so long.</p>

<p>Well, let start from a very basic installation. First at all, we’re going to install <a href="https://github.com/nvm-sh/nvm">NVM</a>, a version manager for Node, I like it because it’s very easy to install and let us change node versions very easily.</p>

<p>As you can read in their github page, just install running the install script.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>curl <span class="nt">-o-</span> https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash
<span class="nb">export </span><span class="nv">NVM_DIR</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">XDG_CONFIG_HOME</span><span class="p">-</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> %s <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/.nvm"</span> <span class="o">||</span> <span class="nb">printf</span> %s <span class="s2">"</span><span class="k">${</span><span class="nv">XDG_CONFIG_HOME</span><span class="k">}</span><span class="s2">/nvm"</span><span class="k">)</span><span class="s2">"</span>
<span class="o">[</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$NVM_DIR</span><span class="s2">/nvm.sh"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\.</span> <span class="s2">"</span><span class="nv">$NVM_DIR</span><span class="s2">/nvm.sh"</span> <span class="c"># This loads nvm</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><em><strong>NOTE</strong>: If you are using zsh or other terminal, check in your <code class="highlighter-rouge">.zshrc</code> if you have the export you’ve just run.</em></p>

<p>Now, install a stable node version, usually your cloud provider support the latest stable version, but check it out in order to verify version you’ve to install.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nvm install node stable
</pre></td></tr></tbody></table></code></pre></div></div>
<p>And now it’s time to install Serverless</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>npm install <span class="nt">-g</span> serverless
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Create the project and install <a href="https://github.com/dherault/serverless-offline">serverless offline</a> a very useful plugin to run your function in localhost.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>sls create <span class="nt">--template</span> aws-nodejs <span class="nt">--path</span> sls-telegram-bot
<span class="nb">cd </span>sls-telegram-bot
npm install serverless-offline <span class="nt">--save-dev</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="coding-our-function">Coding our function</h3>
<p>Our <code class="highlighter-rouge">handler.js</code> is going to be our entrypoint. We are going to see my backend logic, if you don’t mind about this point, just jump to serverless configuration section. Here I’m going to show how crawl a web with cheerio, and do http request with bent. <strong>Don’t jump the part of telegram code, how to manage message and send it.</strong></p>

<h4 id="telegram-module-and-managing-messages">Telegram module and managing messages</h4>
<p>Let’s see our telegram entrypoint, this is where the telegram bot event is received and processed. But not the real entrypoint, this is my telegram.js file.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="s1">'use strict'</span>

<span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bent'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">constants</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./constants'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./utils'</span><span class="p">)</span>

<span class="kd">class</span> <span class="nx">Telegram</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="nx">chatId</span><span class="p">,</span> <span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">chatId</span> <span class="o">=</span> <span class="nx">chatId</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="nx">command</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">chat_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">chatId</span>
        <span class="kd">const</span> <span class="kd">get</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="kd">get</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">SEND_MESSAGE_URI</span><span class="p">,</span> <span class="p">{</span><span class="nx">chat_id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="na">parse_mode</span><span class="p">:</span> <span class="s2">"HTML"</span><span class="p">});</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">400</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">error</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getBuffer</span><span class="p">(</span><span class="nx">response</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">error_code</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">description</span><span class="p">)</span>
            <span class="nx">text</span> <span class="o">=</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ERROR_MESSAGE</span>
            <span class="kr">await</span> <span class="kd">get</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">SEND_MESSAGE_URI</span><span class="p">,</span> <span class="p">{</span><span class="nx">chat_id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="na">parse_mode</span><span class="p">:</span> <span class="s2">"HTML"</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">getCommand</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">chat</span><span class="p">,</span> <span class="nx">text</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">message</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Telegram</span><span class="p">(</span><span class="nx">chat</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="highlighter-rouge">getCommand</code> function is the first function called, parse event.body and get message object, it return chat and text objects. <code class="highlighter-rouge">Chat</code> contains the id of telegram chat, very important because we’re going to need it later to send message. <code class="highlighter-rouge">Text</code> is the text or command we’ve send it in telegram app. So if I’ve defined <code class="highlighter-rouge">/increment</code> command for my bot, text would be exactly <code class="highlighter-rouge">/increment</code>.</p>

<p><code class="highlighter-rouge">sendMessage</code> is an async function (sync indeed because of await) which let us send message to Telegram API, managing some possible errors. The most interesting here is</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="kd">get</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">SEND_MESSAGE_URI</span><span class="p">,</span> <span class="p">{</span><span class="nx">chat_id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="na">parse_mode</span><span class="p">:</span> <span class="s2">"HTML"</span><span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="highlighter-rouge">parse_mode:"HTML"</code> let us send message as HTML, but take care because HTML supported is very closing. You can get more information about supported HTML <a href="https://core.telegram.org/bots/api#html-style">here</a>.</p>

<h4 id="entrypoint-function">Entrypoint function</h4>
<p>Let’s see the real entrypoint our, <code class="highlighter-rouge">handler.js</code></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">getMessage</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="s1">'/increment'</span><span class="p">:</span>
			<span class="k">return</span> <span class="kr">await</span> <span class="nx">increment</span><span class="p">.</span><span class="nx">getIncrement</span><span class="p">()</span>
		<span class="na">default</span><span class="p">:</span>
			<span class="k">return</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">HELP_MESSAGE</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">covidApp</span> <span class="o">=</span> <span class="k">async</span> <span class="nx">event</span> <span class="o">=&gt;</span> 
<span class="p">{</span>
    <span class="kd">let</span> <span class="nx">telegram</span> <span class="o">=</span> <span class="nx">telegramService</span><span class="p">.</span><span class="nx">getCommand</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>

	<span class="kr">await</span> <span class="nx">getMessage</span><span class="p">(</span><span class="nx">telegram</span><span class="p">.</span><span class="nx">command</span><span class="p">)</span>
	<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">message</span> <span class="o">=&gt;</span> <span class="nx">telegram</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">))</span>

	<span class="k">return</span> <span class="p">{</span><span class="na">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Easy, uh? <strong>It’s very important return {statusCode:200} or whatever code when finished, if you don’t do it properly your lambda function would never finish and you would have to prepare your credit card to be fucked.</strong></p>

<p>At this point we have a module, telegram.js, which handle parsing telegram event and send message callback to our telegram bot. In the other hand we have our handler.js entrypoint which runs as a controller in a MVC architecture and return success code when finished. <strong>Simple as that, we’ve our backend finished</strong></p>

<h3 id="serverless-configuration">Serverless configuration</h3>
<p>Now we’re going to see required configuration in order to deploy our backend. <code class="highlighter-rouge">sls create</code> command create a serverless.yml file, <em>THE MAGIC FILE</em>. This is his content:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="na">service</span><span class="pi">:</span> <span class="s">covid-increment-sls</span>
<span class="na">package</span><span class="pi">:</span>
  <span class="na">exclude</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">README.md</span>
<span class="na">custom</span><span class="pi">:</span>
  <span class="na">myStage</span><span class="pi">:</span> <span class="s">${opt:stage, self:provider.stage}</span>
  <span class="na">myEnvironment</span><span class="pi">:</span>
    <span class="na">TELEGRAM_TOKEN</span><span class="pi">:</span>
      <span class="na">prod</span><span class="pi">:</span> <span class="s">${env:TELEGRAM_TOKEN}</span>
      <span class="na">dev</span><span class="pi">:</span> <span class="s">${env:TELEGRAM_TOKEN_DEV}</span>


<span class="na">provider</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
  <span class="na">runtime</span><span class="pi">:</span> <span class="s">nodejs12.x</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">dev</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s">eu-west-1</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">TELEGRAM_TOKEN</span><span class="pi">:</span> <span class="s">${self:custom.myEnvironment.TELEGRAM_TOKEN.${self:custom.myStage}}</span>

<span class="na">functions</span><span class="pi">:</span>
  <span class="na">covid</span><span class="pi">:</span>
    <span class="na">handler</span><span class="pi">:</span> <span class="s">handler.covidApp</span>
    <span class="na">events</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">covid</span>
          <span class="na">method</span><span class="pi">:</span> <span class="s">post</span>
<span class="err">	</span>  <span class="na">cors</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">plugins</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">serverless-offline</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>An important point here is:</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="na">provider</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
  <span class="na">runtime</span><span class="pi">:</span> <span class="s">nodejs12.x</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>Here define your cloud provider and your runtime environment. Another important point is:</p>
</blockquote>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">TELEGRAM_TOKEN</span><span class="pi">:</span> <span class="s">${self:custom.myEnvironment.TELEGRAM_TOKEN.${self:custom.myStage}}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>Here we are setting our <code class="highlighter-rouge">TELEGRAM_TOKEN</code> variable, which let us point to our bot, we’ll see more abot this later.</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="na">functions</span><span class="pi">:</span>
  <span class="na">covid</span><span class="pi">:</span>
    <span class="na">handler</span><span class="pi">:</span> <span class="s">handler.covidApp</span>
    <span class="na">events</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">covid</span>
          <span class="na">method</span><span class="pi">:</span> <span class="s">post</span>
<span class="err">	</span>  <span class="na">cors</span><span class="pi">:</span> <span class="no">true</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>Here we are defining a <code class="highlighter-rouge">covid</code> Api Gateway which has a handler found it in handler.covidApp function and accept a HTTP POST in http://your-api-endpoint/covid path.</p>
</blockquote>

<p>This isn’t a big important part of our develop, but it’s very interesting has at least 2 environments deployed, which means 2 telegram bots, which means 2 telegram tokens. So to manage this we create two different deployment configuration, <code class="highlighter-rouge">prod</code> and <code class="highlighter-rouge">dev</code> and do it possible thanks to Serverless Variables.</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="na">custom</span><span class="pi">:</span>
  <span class="na">myStage</span><span class="pi">:</span> <span class="s">${opt:stage, self:provider.stage}</span>
  <span class="na">myEnvironment</span><span class="pi">:</span>
    <span class="na">TELEGRAM_TOKEN</span><span class="pi">:</span>
      <span class="na">prod</span><span class="pi">:</span> <span class="s">${env:TELEGRAM_TOKEN}</span>
      <span class="na">dev</span><span class="pi">:</span> <span class="s">${env:TELEGRAM_TOKEN_DEV}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>If we want to deploy our function in <code class="highlighter-rouge">dev stage</code> we run <code class="highlighter-rouge">sls deploy --stage dev</code></p>
</blockquote>

<h3 id="creating-a-telegram-bot">Creating a Telegram bot</h3>

<p>This step it’s very simple, just open Telegram and search for <em>@BotFather</em>
<img src="/assets/images/sls-telegram-bot/botfather.jpeg" style="width: 100%" /></p>

<p>Type /newbot and follow the instructions:
<img src="/assets/images/sls-telegram-bot/netbow.png" style="width: 100%" /></p>

<p>Copy your telegram token and export it in your console, or export in .bashrc or .zshrc as <code class="highlighter-rouge">TELEGRAM_TOKEN</code>
<img src="/assets/images/sls-telegram-bot/created.png" style="width: 100%" /></p>

<p>Now open your code and in whereever you want create a constant like this</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">SEND_MESSAGE_URI</span><span class="p">:</span> <span class="s2">`https://api.telegram.org/bot</span><span class="p">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TELEGRAM_TOKEN</span><span class="p">}</span><span class="s2">/sendMessage`</span><span class="p">,</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Actually, Serverless is who is going to set TELEGRAM_TOKEN depends on the stage you are deploying your function as we have seen in <code class="highlighter-rouge">serverless.yml</code> configuration.</p>

<h3 id="deploying-and-linking-back-end">Deploying and linking back-end</h3>
<p>It’s time to deploy, we have our bot created and our telegram token, we have our function and our serverless configuration… but… what happen with AWS? Let’s see how do a minimal configuration to deploy serverless functions, very simple. Let’s go to AWS console &gt; IAM &gt; Users.</p>

<p><img src="/assets/images/sls-telegram-bot/aws.png" style="width: 100%" /></p>

<p>Create an user with programmatic access and download his credentials. Then, create, if you don’t have yet, .aws folder in your home directory. Go into it and create <code class="highlighter-rouge">credentials</code> file. You’ve to write something like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>[default]
aws_access_key_id = ACCESS_KEY
aws_secret_access_key = SECRET_ACCESS_KEY
region = eu-west-1
</pre></td></tr></tbody></table></code></pre></div></div>
<p>If you are a bit confused with this, check <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html">AWS official guide to create an user</a> and <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html">configuration and credential file setting</a>.</p>

<p>It’s deploy time! First you have to deploy your function with</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sls deploy <span class="nt">--stage</span> dev
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This will output something like this:</p>

<p><img src="/assets/images/sls-telegram-bot/slsoutput.png" style="width: 100%" /></p>

<p>As you can see Serverless create a lot of things under the hood, using services like CloudFormation, API Gateway and S3.</p>

<p>Now copy your entrypoint URL and attach to your telegram bot, let him know where your backend is running this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>curl <span class="nt">--request</span> POST <span class="nt">--url</span> https://api.telegram.org/bot<span class="nv">$TELEGRAM_TOKEN_DEV</span>/setWebhook <span class="nt">--header</span> <span class="s1">'content-type: application/json'</span> <span class="nt">--data</span> <span class="s1">'{"url": "https://your-api-endpoint/dev/covid"}'</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>you’ll get something like</p>
  <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="s2">"ok"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="s2">"result"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="s2">"description"</span><span class="p">:</span><span class="s2">"Webhook is already set"</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>  </div>
</blockquote>

<p>Test your bot!</p>

<p><img src="/assets/images/sls-telegram-bot/testbot.png" style="width: 100%" /></p>

<h3 id="conclusions-and-resources">Conclusions and resources</h3>
<p>Well, thanks for reading until final. We’ve learned how to deploy a serverless function to AWS and attach to Telegram Bot. There are a lot of missing details like creating telegram commands, the backend code and an AWS deployed services. It was a very basic guide of deploying function fast and easy, from this point we can improve a lot of our code or use more AWS services as DynamoDB which let us store <code class="highlighter-rouge">chat.id</code> variable to send laterly messages to all chat who started our bot, making “subscription bots” possible.</p>

<p>You can find my Covid project <a href="https://github.com/Chillaso/Covid-Telegram-Serverless">here</a> it’s very very basic, and probably there are a lot of errors, but it’s for personal use and as a proof of concept, perhaps I’ll improve it and learn more things about it or migrate it to Golang.</p>

<p>If you want to contribute to COVID telegram bot, don’t think it so much, do it, I’ll appreciate it so much :)</p>

<p>I hope you enjoy and have learned something, thanks you so much for reading,</p>

<p>See you soon, exit(0);</p>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2020-04-01">01 Apr 2020</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#project">project</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/tags#cloud">#cloud</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#serverless">#serverless</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#telegram">#telegram</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#tutorial">#tutorial</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="/kotlin-spring-restful/"> &laquo; RESTful API with Spring and Kotlin</a>
            
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>
    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#tutorial">tutorial (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#project">project (2)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2022 Carlos Chilla 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>


<script src="/assets/js/lazyload.js"></script>


<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 
</body>

</html>
